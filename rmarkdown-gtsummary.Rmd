---
title: "gtsummary"
author: "Daniel D. Sjoberg, Karissa Whiting, Margaret Hannum, Emily C. Zabor, Michael Curry"
output:
  pdf_document:
    keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(gtsummary)
library(tidyverse)
library(gt)

theme_gtsummary_compact()
set_gtsummary_theme(list(
  "as_gt-lst:addl_cmds" = list("cols_hide" = rlang::expr(gt::tab_options(table.font.names = "palatino")))
))
```

# Introduction

# Data Summaries

```{r, results='asis'}
trial %>%
  imap_dfr(
    ~tibble(
      colname = str_glue('`{.y}`'), 
      label = attr(.x, "label"), 
      class = class(.x), 
      values = trial %>% select(.y) %>% distinct() %>% 
        arrange(!!rlang::sym(.y)) %>% slice(1:4) %>% pull(.y) %>% 
        na.omit() %>% {paste("`", ., "`", collapse = ", ")}
    ) %>%
      mutate(
        values = ifelse(length(unique(na.omit(trial[[.y]]))) > 4,
                        paste(values, ", ..."),
                        values) 
      )
  ) %>%
  gt() %>%
  fmt_markdown(everything()) %>%
  cols_align("left", everything()) %>%
  as_latex() %>%
  as.character() %>%
  str_replace(fixed("\\toprule"), fixed("\\caption{\\label{tab:}Example data frame, \\texttt{trial}}\\\\\n\\toprule")) %>%
  readr::write_lines("tbl_trial_desc.tex")
```

% latex comment ?

## `tbl_summary()`

```{r, echo=TRUE}
tbl_summary_1 <-
  trial %>%
  select(age, grade, response, trt) %>%
  tbl_summary(by = trt)
```

```{r, echo=FALSE, include = FALSE}
tbl_summary_1 %>% 
  as_gt() %>%
  gtsave(file = "summary_basic.png")
```

```{r}
tibble::tribble(
  ~Argument,       ~Description,
  "`label=`",       "specify the variable labels printed in table",
  "`type=`",        "specify the variable type (e.g. continuous, categorical, etc.)",
  "`statistic=`",   "change the summary statistics presented",
  "`digits=`",      "number of digits the summary statistics will be rounded to",
  "`missing=`",     "whether to display a row with the number of missing observations",
  "`missing_text=`","text label for the missing number row",
  "`sort=`",        "change the sorting of categorical levels by frequency",
  "`percent=`",     "print column, row, or cell percentages",
  "`include=`",     "list of variables to include in summary table"
) %>%
  gt() %>%
  fmt_markdown(everything()) %>%
  as_latex() %>%
  as.character() %>%
  str_replace(fixed("\\toprule"), fixed("\\caption{\\label{tab:}\\texttt{tbl\\_summary()} function arguments}\\\\\n\\toprule")) %>%
  readr::write_lines("tbl_tbl_summary_args.tex")

```

```{r, echo=TRUE}
tbl_summary_2 <-
  trial %>%
  select(age, grade, response, trt) %>%
  tbl_summary(
    by = trt,
    type = age ~ "continuous2",
    label = age ~ "Patient Age",
    statistic = list(age ~ c("{N_nonmiss}", "{mean} ({sd})"),
                     c(grade, response) ~ "{n} / {N} ({p}%)"),
    digits = c(grade, response) ~ c(0, 0, 1),
    missing = "no"
  )
```

```{r, echo=FALSE, include = FALSE}
tbl_summary_2 %>% 
  as_gt() %>%
  gtsave(file = "summary_plus.png")
```

```{r}
tibble::tribble(
  ~Function,             ~Description,
  "`add_p()`",           "add p-values to the output comparing values across groups",   
  "`add_overall()`",     "add a column with overall summary statistics",   
  "`add_n()`",           "add a column with N (or N missing) for each variable",
  "`add_difference()`",  "add column for difference between two group, confidemce interval, and p-value",
  "`add_stat_label()`",  "add label for the summary statistics shown in each row",   
  "`add_stat()`",        "generic function to add a column with user-defined values",
  "`add_q()`",           "add a column of q values to control for multiple comparisons"   
) %>%
  gt(caption = "`tbl_summary()` functions to add information") %>%
  fmt_markdown(everything()) %>%
  fmt_markdown(everything()) %>%
  as_latex() %>%
  as.character() %>%
  str_replace(fixed("\\toprule"), fixed("\\caption{\\label{tab:}\\texttt{tbl\\_summary()} functions to add information}\\\\\n\\toprule")) %>%
  readr::write_lines("tbl_tbl_summary_family.tex")
```

```{r, echo=TRUE}
tbl_summary_3 <-
  trial %>%
  select(age, grade, response, trt) %>%
  tbl_summary(by = trt, missing = "no") %>%
  add_p(test = all_continuous() ~ "t.test",
        pvalue_fun = ~style_pvalue(., digits = 2)) %>%
  add_n()
```

```{r, echo=FALSE, include = FALSE}
tbl_summary_3 %>% 
  as_gt() %>%
  gtsave(file = "summary_plus_plus.png")
```

\begin{figure}[h!]
  \caption{Simple `tbl\_summary()` example}
  \label{fig:summary_basic}
  \includegraphics[height=5cm]{summary_basic.png}
  \centering
\end{figure}

## `tbl_svysummary()`

```{r}
data(api, package = "survey")

# create weighted survey object, keep only two counties
svy_api <- 
  survey::svydesign(id = ~dnum, weights = ~pw, data = apiclus1, fpc = ~fpc) %>%
  subset(cname %in% c("Alameda", "Los Angeles"))

# summarize data
tbl_svysummary_1 <-
  svy_api %>%
  tbl_svysummary(by = cname, 
                 include = c(growth, target, cname),
                 label = list(growth ~ "Growth",
                              target ~ "Target")) %>%
  add_p()
```

```{r, echo=FALSE, include = FALSE}
tbl_svysummary_1 %>% 
  as_gt() %>%
  gtsave(file = "svysummary.png")
```

## `tbl_cross()`

```{r}
tbl_cross_1 <-
  trial %>%
  tbl_cross(row = stage, col = trt, percent = "cell") %>%
  add_p(source_note = TRUE)
```

```{r, echo=FALSE, include = FALSE}
tbl_cross_1 %>% 
  as_gt() %>%
  gtsave(file = "cross.png")
```

## `tbl_survfit()`

```{r}
library(survival)

tbl_survfit_1 <-
  list(survfit(Surv(ttdeath, death) ~ trt, trial),
       survfit(Surv(ttdeath, death) ~ grade, trial)) %>%
  tbl_survfit(times = c(12, 24),
              label_header = "**{time} Month**") %>%
  add_p()
```

```{r, echo=FALSE, include = FALSE}
tbl_survfit_1 %>% 
  as_gt() %>%
  gtsave(file = "survfit.png")
```

## Customization

```{r}
tibble::tribble(
  ~Function,                     ~Description,
  "`modify_header()`",           "update column headers",   
  "`modify_footnote()`",         "update column footnote",   
  "`modify_spanning_header()`",  "update spanning headers",   
  "`bold_labels()`",             "bold variable labels",  
  "`bold_levels()`",             "bold variable levels",  
  "`italicize_labels()`",        "italicize variable labels",  
  "`italicize_levels()`",        "italicize variable levels",  
  "`bold_p()`",                  "bold significant p-values"
) %>%
  gt() %>%
  fmt_markdown(everything()) %>%
  fmt_markdown(everything()) %>%
  as_latex() %>%
  as.character() %>%
  str_replace(fixed("\\toprule"), fixed("\\caption{\\label{tab:} Functions to style and modify gtsummary tables}\\\\\n\\toprule")) %>%
  readr::write_lines("tbl_modify.tex")
```

```{r,echo=FALSE}
tbl_custom <-
  trial %>%
  select(age, grade, trt) %>%
  tbl_summary(by = trt, missing = "no") %>%
  add_overall() %>%
  add_p() %>%
  add_stat_label() %>%
  modify_header(label ~ "**Variable**") %>% 
  modify_spanning_header(c(stat_1, stat_2) ~ "**Treatment Received**") %>%
  as_gt() %>%
  gt::tab_header(
    title = gt::md("**Table 1. Patient Characteristics**"),
    subtitle = gt::md("_Highly Confidential_")
  ) %>%
  gt::tab_source_note("Data updated June 26, 2015")
```

```{r, echo=FALSE, include = FALSE}
tbl_custom %>% 
  gtsave(file = "custom.png")
```

# Model Summaries

## `tbl_regression()`

```{r}
tbl_regression_1 <-
  glm(response ~ age + grade, trial, family = binomial) %>%
  tbl_regression(exponentiate = TRUE) %>%
  add_global_p()
```

```{r, echo=FALSE, include = FALSE}
tbl_regression_1 %>% 
  as_gt() %>%
  gtsave(file = "regression.png")
```

## `tbl_uvregression()`

```{r}
tbl_uvregression_1 <-
  trial %>%
  select(response, age, grade) %>%
  tbl_uvregression(
    y = response, 
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(., digits = 2)
  ) %>%
  add_nevent() %>%
  add_global_p()
```

```{r, echo=FALSE, include = FALSE}
tbl_uvregression_1 %>% 
  as_gt() %>%
  gtsave(file = "uvregression.png")
```

# Merging and Stacking

```{r}
tbl1 <-
  glm(response ~ age + grade, trial, family = binomial) %>%
  tbl_regression(exponentiate = TRUE) %>%
  add_global_p()

tbl2 <-
  coxph(Surv(ttdeath, death) ~ age + grade, trial) %>%
  tbl_regression(exponentiate = TRUE) %>%
  add_global_p()

tbl_merge_1 <-
  tbl_merge(
    tbls = list(tbl1, tbl2),
    tab_spanner = c("**Tumor Response**", "**Time to Death**")
  )
```

```{r, echo=FALSE, include = FALSE}
tbl_merge_1 %>% 
  as_gt() %>%
  gtsave(file = "merge.png")
```

# Inline Reporting

To report the result for `age`, use the following commands inline.

> `` `r
inline_text(tbl_uvregression_1, variable = age)` `` 

Here's how the line will appear in your report.

> `r inline_text(tbl_uvregression_1, variable = age)`

# Themes

```{r, echo=TRUE}
theme_gtsummary_journal("nejm")

tbl_nejm <-
  glm(response ~ age + grade, trial, family = binomial) %>%
  tbl_regression(exponentiate = TRUE)
```

```{r, echo=FALSE, include = FALSE}
tbl_nejm %>% 
  as_gt() %>%
  gtsave(file = "nejm.png")
```

# Print Engines
